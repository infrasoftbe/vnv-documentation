import React, { useMemo } from 'react';

import Playground from '@theme/Playground';
import Details from "@theme/Details";

import { Management } from '@infrasoftbe/infrasoft-vnv-api-kit';
import { CodeBlock, CodeBlockCode } from '@patternfly/react-core';

# Rights

Ce module de gestion des droits permet de définir des règles d’accès précises pour des modules, des items et des champs. Chaque règle est structurée en utilisant une syntaxe standardisée de sélecteurs et d’opérations.

[Documentation API](../../../../API/infrasoft-vnv-api-kit/functions/Management.Rights.html)

## Structure de la Syntaxe

Chaque règle est composée de plusieurs éléments de sélecteur, permettant d’indiquer :

- Les [Modules](../../../Application/modules/Modules.md) ciblés (un ou plusieurs).
- Les Items associés aux modules.
- Les Champs d’items.
- Les Métadonnées et les champs associés aux couches de métadonnées.

Des Opérations spécifiques peuvent être appliquées sur chaque type d’élément.

## Sélecteurs

Les sélecteurs définissent les composants de la hiérarchie de permissions. Voici la syntaxe pour chaque type de sélecteur :

- Modules : `$[NomModule1]$[NomModule2]$...` **ou** `$*` — Sélectionne un module ou une hiérarchie de modules.
- Items : `__[NomItem | *]` — Sélectionne un item spécifique ou tous les items.
- Champs : `:f&[NomChamp | *]` — Sélectionne un champ d’item spécifique ou tous les champs.
- Couches de métadonnées : `:m.[NomCouche1].[NomCouche2]` **ou** `:m*` — Sélectionne une couche de métadonnées spécifique ou toute les couches.
- Champs de métadonnées : `:m.[NomCouche | *]:f&[NomChampMeta | *]` — Sélectionne un champ spécifique dans une couche de métadonnées ou tout les champs.

## Opérations

Chaque règle peut appliquer une ou plusieurs opérations sur le module, l’item ou le champ spécifié :

- `--* :` toutes les opérations
- `--read` : lecture ( ⚠️par défaut `true` si un **Item** ou **Field** est spécifié⚠️ )
- `--write` : écriture
- `--delete` : suppression
- `--import` : importation
- `--export` : exportation

### Modificateur de Requête sur les Items (NOT YET IMPLEMENTED)

Un item peut être sélectionné via une requête, utilisant la syntaxe suivante pour spécifier un item répondant à certains critères :

```tsx
__{{itemname}}(WHERE:f:token = "token"&&:f:id = "id")
```

## Exemples de Syntaxe

Voici des exemples concrets pour illustrer les possibilités de la syntaxe et des sélecteurs.

### Exemple de Configuration d’Administrateur

```tsx
const rights = [
  // All_Modules -> All_Rights
  "$*--*",
  // All_Modules -> All_Items -> All_Rights
  "$*__*--*",
  // All_Modules -> All_Items -> All_Fields -> All_Rights
  "$*__*:f&*--*",
  // All_Modules -> All_Items -> All_Metadata_layers -> All_Fields -> All_Rights
  "$*__*:m.*:f&*--*",
];
```

### Exemples Génériques

Ces exemples montrent des configurations plus spécifiques, ciblant des [modules](../../../Application/modules/Modules.md), des items, ou des champs particuliers.

#### Integration

Importez le module [infrasoft-vnv-api-kit](../../../packages/vnv-api-kit/), Utilisez <a href="../../../../API/infrasoft-vnv-api-kit/modules/Management.html" target="_blank">Management</a> qui propose l’utilitaire <a href="../../../../API/infrasoft-vnv-api-kit/functions/Management.Rights.html" target="_blank">Rights</a>. Cet utilitaire permet d’interpréter un tableau de droits ( <a href="../../../../API/infrasoft-vnv-api-kit/classes/Management.ArrayRights.html" target="_blank">ArrayRights</a> ) en un format <a href="../../../../API/infrasoft-vnv-api-kit/classes/Management.ArrayRights.html#json" target="_blank">JSON</a>.

```tsx
import { Management } from "@infrasoftbe/infrasoft-vnv-api-kit";
```

<Details summary="Module & Operation">

#### Code

```tsx
import { Management } from "@infrasoftbe/infrasoft-vnv-api-kit";

let right = ["$Navigator.Simple--*"];
console.log({ rights: Management.Right().json() });
```

#### Output

```json
{
  "Navigator": {
    "operations": {
      "read": true
    },
    "Simple": {
      "operations": {
        "read": true,
        "write": true,
        "delete": true,
        "import": true,
        "export": true
      },
      "items": {}
    }
  }
}
```

</Details>

<Details summary="Module & Item">
  Voici le contenu de l'accordéon. Vous pouvez y mettre tout ce que vous voulez, comme du texte, des listes ou même d'autres composants.

#### Code

```tsx
import { Management } from "@infrasoftbe/infrasoft-vnv-api-kit";

let right = ["$Navigator.Simple__project"];
console.log({ rights: Management.Right().json() });
```

#### Output

```json
{
  "Navigator": {
    "operations": {
      "read": true
    },
    "Simple": {
      "operations": {
        "read": true
      },
      "items": {
        "project": {
          "operations": {
            "read": true
          },
          "fields": {},
          "metadata": {}
        }
      }
    }
  }
}
```

</Details>

<Details summary="Cascading rights">
  Voici le contenu de l'accordéon. Vous pouvez y mettre tout ce que vous voulez, comme du texte, des listes ou même d'autres composants.

#### Code

```tsx
import { Management } from "@infrasoftbe/infrasoft-vnv-api-kit";

let right = [
  "$Navigator.Simple--import",
  "$Navigator.Simple--export",
  "$Navigator.Simple--delete",
  "$Navigator.Simple__project",
  "$Navigator.Simple__project--delete",
  "$Navigator.Simple__project--import",
  "$Navigator.Simple__project--export",
  "$Navigator.Simple__project:f&name",
  "$Navigator.Simple__project:f&token",
  "$Navigator.Simple__project:f&create_dt",
  "$Navigator.Simple__project:f&update_dt",
  "$Navigator.Simple__project:m.:f&description--write",
];
console.log({ rights: Management.Right().json() });
```

#### Output

```json
{
  "operations": { "read": true },
  "Simple": {
    "operations": {
      "read": true,
      "write": false,
      "delete": true,
      "import": true,
      "export": true
    },
    "items": {
      "project": {
        "operations": {
          "read": true,
          "write": false,
          "delete": true,
          "import": true,
          "export": true
        },
        "fields": {
          "name": {
            "operations": {
              "read": true,
              "write": false,
              "delete": false,
              "import": false,
              "export": false
            }
          },
          "token": {
            "operations": {
              "read": true,
              "write": false,
              "delete": false,
              "import": false,
              "export": false
            }
          },
          "create_dt": {
            "operations": {
              "read": true,
              "write": false,
              "delete": false,
              "import": false,
              "export": false
            }
          },
          "update_dt": {
            "operations": {
              "read": true,
              "write": false,
              "delete": false,
              "import": false,
              "export": false
            }
          }
        },
        "metadata": {
          "description": {
            "operations": {
              "read": true,
              "write": true,
              "delete": false,
              "import": false,
              "export": false
            }
          }
        }
      }
    }
  }
}
```

</Details>

<!-- <Playground
  scope={{
    React,
    Management,
    CodeBlock,
    CodeBlockCode
  }}
  transformCode={(code) => `
    (() => {
      ${code}
    })()
  `}
>
  {`
  function TestZone(){

    let [ rights , setRights ] = React.useState([
      "$Navigator.Simple"
    ]);
    let [ jsonRights , setJsonRights ] = React.useState(null);

    React.useEffect(() => {
      setJsonRights( Management.Rights( rights ).json() );
    });

    return <CodeBlock>
      <CodeBlockCode>{JSON.stringify( jsonRights || {} , null , '\t' )}</CodeBlockCode>
    </CodeBlock>;
  }
`}
</Playground> -->

<!-- <div>
  {React.createElement(() => {
    const TestZone = () => {

      let [rights, setRights] = React.useState(["$Navigator.Simple"]);
      let [jsonRights, setJsonRights] = React.useState(null);

      React.useEffect(() => {
        setJsonRights(Management.Rights(rights).json());
      });

      return <React.Fragment>
        <input></input>
        <CodeBlock>
          <CodeBlockCode>{JSON.stringify(jsonRights || {}, null, "\t")}</CodeBlockCode>
        </CodeBlock>
      </React.Fragment>;

    };

    return <TestZone />;
  })}
</div> -->

## Test zone

<div>
  {React.createElement(() => {
    const TestZone = () => {
      const [rights, setRights] = React.useState(["$Navigator.Simple"]);
      const [jsonRights, setJsonRights] = React.useState(null);

      React.useEffect(() => {
        console.log({ rights })
        setJsonRights(Management.Rights(rights).json());
      }, [rights]);

      // Gestion des valeurs d'input dans une liste dynamique
      const handleInputChange = React.useCallback((index, value) => {
        setRights((prevRights) => {
          const updatedValues = [...prevRights];
          updatedValues[index] = value;

          // Retire les inputs vides sauf le dernier
          return updatedValues.filter((v, i) => v.trim() !== "" || i === updatedValues.length - 1);
        });
      }, []);

      return (
        <React.Fragment>
          <div style={{ display: "flex" , flexDirection: "column" }}>
            {[...rights , ''].map((value, index) => (
              <input
                key={index}
                value={value}
                onChange={(e) => handleInputChange(index, e.target.value)}
                placeholder="Enter value"
                style={{ display: "block", marginBottom: "8px" , fontWeight : "bold" }}
              />
            ))}
          </div>
          <CodeBlock>
            <CodeBlockCode>{JSON.stringify(jsonRights || {}, null, "\t")}</CodeBlockCode>
          </CodeBlock>
        </React.Fragment>
      );
    };

    return <TestZone />;
  })}
</div>

```tsx
const rights = [
  "$Navigator.Simple__project",

  // Autorise toutes les opérations sur le champ `token` de tous les items du module `OperationalSupport`
  "$OperationalSupport$*__*:f&token--*",

  // Autorise l'opération `create` sur le champ `description` de l'item `work` du module `SupportKnowledge`
  "$SupportKnowledge$*__work:f&description--create",
];
```

### Exemples Avancés de Cascade et Filtrage

Ces exemples montrent comment restreindre les permissions en utilisant des couches de métadonnées et des requêtes de sélection d’items.

```tsx
const rights = [
  // Autorise l'opération `read` sur le champ `description` d'un item de métadonnée dans le module `Structureren`
  "$ManagementSupport$ExecutionInformationSystem$ConfigurationManager$Structureren__structure:m:f:description--read",
  // Autorise toutes les opérations pour le champ `description` de l'item ayant l'ID `listId` dans une couche de métadonnées
  "$ManagementSupport$ExecutionInformationSystem$ConfigurationManager$Structureren__list(WHERE:f:id=`listId`):m:f:description--*",
];
```

### Fonctionnalités et Cascade des Permissions

Les permissions s’appliquent avec une hiérarchie en cascade :

- Modules : Les droits peuvent être attribués à des modules entiers ou à des sous-modules en utilisant un \* pour capturer tous les sous-modules.
- Items : Chaque item d’un module peut avoir des permissions spécifiques.
- Champs : Des champs spécifiques d’un item peuvent être sélectionnés pour définir des droits précis.
- Métadonnées : Les permissions sur les métadonnées sont structurées avec des couches, permettant d’accéder à des niveaux spécifiques de métadonnées.

#### Exemple de Cascade

Les règles de cascade permettent de définir des droits globaux ou spécifiques selon la hiérarchie. Par exemple :

```tsx
const rights = [
  // Permet l'opération `read` pour le champ `description` dans les métadonnées d'un item du module `Structureren`
  "$ManagementSupport$ExecutionInformationSystem$ConfigurationManager$Structureren__structure:m:f:description--read",
  // Autorise toutes les opérations sur le champ `description` pour une liste spécifique d'items dans `Structureren`
  "$ManagementSupport$ExecutionInformationSystem$ConfigurationManager$Structureren__list(WHERE:f:id=`listId`):m:f:description--*",
];
```

Dans cet exemple :

- La première règle limite les droits au champ description en mode read dans les métadonnées.
- La seconde règle applique toutes les opérations sur le champ description pour un item spécifique dans une liste, illustrant ainsi la flexibilité des permissions de métadonnées.

## Implémentation

### Import dans un projet

```tsx
import { Management } from "@infrasoftbe/infrasoft-vnv-api-kit";
```

Chaque règle de droits est traduite dans un objet JSON facilitant l’accès aux données par les modules de l’application.

#### Exemple de Résultat JSON

```tsx
import { Management } from '@infrasoftbe/infrasoft-vnv-api-kit'

let rights = Management.Rights([
  "$ManagementSupport$ExecutionInformationSystem$ConfigurationManager$Structureren__structure:m:f:description--read",
  "$ManagementSupport$ExecutionInformationSystem$ConfigurationManager$Structureren__list(WHERE:f:id=`listId`):m:f:description--*",
]);

conosle.log({ rights : rights.json() })
/** Print
{
  "ManagementSupport": {
    "ExecutionInformationSystem": {
      "ConfigurationManager": {
        "Structureren": {
          "structure": {
            "operations": {
              "read": true,
              "write": false,
              "delete": false
            },
            "fields": {
              // Autres champs
            },
            "metadata": {
              "description": {
                "read": true,
                "write": false,
                "delete": false
              }
              // Autres métadonnées
            }
          },
          "except": {
            "listId": {
              "metadata": {
                "description": {
                  "read": true,
                  "write": true,
                  "delete": true
                }
              }
            }
          }
        }
      }
    }
  }
}
*/
`
```
